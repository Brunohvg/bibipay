{% extends "base/base.html" %}

{% block title %}Cadastrar Vendedor{% endblock %}
{% block page_title %}Cadastrar Novo Vendedor{% endblock %}
{% block page_subtitle %}Preencha as informações abaixo para registrar um novo vendedor no sistema{% endblock %}

{% block extra_css %}
<style>
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-instructions {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
        border-left: 4px solid var(--primary);
        padding: 18px 22px;
        border-radius: 12px;
        margin-bottom: 28px;
    }

    .form-instructions h4 {
        font-size: 15px;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-instructions p {
        font-size: 13px;
        color: var(--gray-600);
        margin: 0;
        line-height: 1.8;
    }

    .form-section-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--gray-800);
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--gray-100);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
        padding-top: 24px;
        border-top: 1px solid var(--gray-200);
        margin-top: 32px;
    }

    .password-strength {
        margin-top: 8px;
        font-size: 12px;
    }

    .strength-bar {
        height: 4px;
        background: var(--gray-200);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 6px;
    }

    .strength-fill {
        height: 100%;
        transition: all 0.3s ease;
        border-radius: 2px;
    }

    .strength-weak .strength-fill {
        width: 33%;
        background: var(--danger);
    }

    .strength-medium .strength-fill {
        width: 66%;
        background: var(--warning);
    }

    .strength-strong .strength-fill {
        width: 100%;
        background: var(--success);
    }

    .input-with-icon {
        position: relative;
    }

    .input-icon {
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-400);
        font-size: 14px;
        pointer-events: none;
        transition: color 0.3s ease;
    }

    .form-control:focus ~ .input-icon,
    .form-control-lg:focus ~ .input-icon {
        color: var(--primary);
    }

    .has-icon {
        padding-right: 44px !important;
    }

    .required-field::after {
        content: '*';
        color: var(--danger);
        margin-left: 4px;
    }

    .form-help {
        font-size: 12px;
        color: var(--gray-500);
        margin-top: 6px;
        display: block;
    }

    .requirements-box {
        background: var(--gray-50);
        padding: 18px;
        border-radius: 12px;
        margin-top: 20px;
        border: 1px solid var(--gray-200);
    }

    .requirements-box h6 {
        font-size: 13px;
        font-weight: 700;
        color: var(--gray-700);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .requirements-box ul {
        font-size: 12px;
        color: var(--gray-600);
        margin: 0;
        padding-left: 24px;
        line-height: 1.9;
    }

    .requirements-box li {
        margin-bottom: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card" style="max-width: 950px; margin: 0 auto;">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-user-plus" style="color: var(--primary);"></i>
            Dados do Vendedor
        </h3>
    </div>

    <div class="card-body">
        <div class="form-instructions">
            <h4>
                <i class="fas fa-info-circle"></i>
                Informações Importantes
            </h4>
            <p>
                • O vendedor receberá um e-mail com as credenciais de acesso<br>
                • A taxa de comissão padrão é de 1% sobre as vendas<br>
                • O vendedor poderá lançar suas vendas diariamente através do aplicativo mobile
            </p>
        </div>

        <form method="post" novalidate id="vendedorForm">
            {% csrf_token %}

            <!-- Dados Pessoais -->
            <h5 class="form-section-title">
                <i class="fas fa-user" style="color: var(--primary);"></i>
                Dados Pessoais
            </h5>

            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.first_name.id_for_label }}" class="form-label required-field">Nome</label>
                    <div class="input-with-icon">
                        {{ form.first_name }}
                        <i class="fas fa-user input-icon"></i>
                    </div>
                    {% if form.first_name.errors %}
                        {% for error in form.first_name.errors %}
                            <span class="form-error"><i class="fas fa-exclamation-circle"></i> {{ error }}</span>
                        {% endfor %}
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.last_name.id_for_label }}" class="form-label required-field">Sobrenome</label>
                    <div class="input-with-icon">
                        {{ form.last_name }}
                        <i class="fas fa-user input-icon"></i>
                    </div>
                    {% if form.last_name.errors %}
                        {% for error in form.last_name.errors %}
                            <span class="form-error"><i class="fas fa-exclamation-circle"></i> {{ error }}</span>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.email.id_for_label }}" class="form-label required-field">E-mail</label>
                    <div class="input-with-icon">
                        {{ form.email }}
                        <i class="fas fa-envelope input-icon"></i>
                    </div>
                    {% if form.email.errors %}
                        {% for error in form.email.errors %}
                            <span class="form-error"><i class="fas fa-exclamation-circle"></i> {{ error }}</span>
                        {% endfor %}
                    {% endif %}
                    <small class="form-help">Este será o login do vendedor no sistema</small>
                </div>

                <div class="form-group">
                    <label for="{{ form.cpf.id_for_label }}" class="form-label required-field">CPF</label>
                    <div class="input-with-icon">
                        {{ form.cpf }}
                        <i class="fas fa-id-card input-icon"></i>
                    </div>
                    {% if form.cpf.errors %}
                        {% for error in form.cpf.errors %}
                            <span class="form-error"><i class="fas fa-exclamation-circle"></i> {{ error }}</span>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>

            <!-- Senha de Acesso -->
            <h5 class="form-section-title" style="margin-top: 32px;">
                <i class="fas fa-lock" style="color: var(--primary);"></i>
                Senha de Acesso
            </h5>

            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.password1.id_for_label }}" class="form-label required-field">Senha</label>
                    <div class="input-with-icon">
                        {{ form.password1 }}
                        <i class="fas fa-lock input-icon"></i>
                    </div>
                    {% if form.password1.errors %}
                        {% for error in form.password1.errors %}
                            <span class="form-error"><i class="fas fa-exclamation-circle"></i> {{ error }}</span>
                        {% endfor %}
                    {% endif %}
                    <div class="password-strength" id="passwordStrength" style="display: none;">
                        <div class="strength-bar">
                            <div class="strength-fill"></div>
                        </div>
                        <span class="strength-text" style="font-size: 12px; color: var(--gray-600); margin-top: 4px; display: block;"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="{{ form.password2.id_for_label }}" class="form-label required-field">Confirmar Senha</label>
                    <div class="input-with-icon">
                        {{ form.password2 }}
                        <i class="fas fa-check-circle input-icon" id="passwordMatchIcon" style="display: none; color: var(--success);"></i>
                    </div>
                    {% if form.password2.errors %}
                        {% for error in form.password2.errors %}
                            <span class="form-error"><i class="fas fa-exclamation-circle"></i> {{ error }}</span>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>

            <div class="requirements-box">
                <h6>
                    <i class="fas fa-shield-alt" style="color: var(--info);"></i>
                    Requisitos de Senha:
                </h6>
                <ul>
                    <li>Mínimo de 8 caracteres</li>
                    <li>Pelo menos uma letra maiúscula e uma minúscula</li>
                    <li>Pelo menos um número</li>
                    <li>Recomendado: caractere especial (@, #, $, etc.)</li>
                </ul>
            </div>

            <!-- Botões de Ação -->
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="window.history.back();">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Cadastrar Vendedor
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Validação de senha em tempo real
    const password1 = document.querySelector('input[name="password1"]');
    const password2 = document.querySelector('input[name="password2"]');
    const strengthDiv = document.getElementById('passwordStrength');
    const matchIcon = document.getElementById('passwordMatchIcon');

    if (password1) {
        password1.addEventListener('input', function() {
            const value = this.value;
            const strength = checkPasswordStrength(value);
            
            if (value.length > 0) {
                strengthDiv.style.display = 'block';
                strengthDiv.className = 'password-strength ' + strength.class;
                strengthDiv.querySelector('.strength-text').textContent = strength.text;
            } else {
                strengthDiv.style.display = 'none';
            }
        });
    }

    if (password2) {
        password2.addEventListener('input', function() {
            const password1Value = password1 ? password1.value : '';
            if (this.value.length > 0 && this.value === password1Value) {
                matchIcon.style.display = 'block';
                matchIcon.className = 'fas fa-check-circle input-icon';
                matchIcon.style.color = 'var(--success)';
                this.style.borderColor = 'var(--success)';
            } else if (this.value.length > 0) {
                matchIcon.style.display = 'block';
                matchIcon.className = 'fas fa-times-circle input-icon';
                matchIcon.style.color = 'var(--danger)';
                this.style.borderColor = 'var(--danger)';
            } else {
                matchIcon.style.display = 'none';
                this.style.borderColor = '';
            }
        });
    }

    function checkPasswordStrength(password) {
        let strength = 0;
        
        if (password.length >= 8) strength++;
        if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
        if (password.match(/[0-9]/)) strength++;
        if (password.match(/[^a-zA-Z0-9]/)) strength++;
        
        if (strength <= 1) {
            return { class: 'strength-weak', text: 'Senha fraca' };
        } else if (strength <= 2) {
            return { class: 'strength-medium', text: 'Senha média' };
        } else {
            return { class: 'strength-strong', text: 'Senha forte' };
        }
    }

    // Máscara de CPF
    const cpfInput = document.querySelector('input[name="cpf"]');
    if (cpfInput) {
        cpfInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                e.target.value = value;
            }
        });
    }

    // Validação do formulário antes de enviar
    const form = document.getElementById('vendedorForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            let isValid = true;
            const requiredInputs = form.querySelectorAll('input[required], input[type="text"], input[type="email"], input[type="password"]');
            
            requiredInputs.forEach(input => {
                if (!input.value.trim()) {
                    isValid = false;
                    input.classList.add('is-invalid');
                    input.style.borderColor = 'var(--danger)';
                } else {
                    input.classList.remove('is-invalid');
                }
            });

            if (!isValid) {
                e.preventDefault();
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Criar alerta temporário
                const existingAlert = document.querySelector('.alert-error');
                if (!existingAlert) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-error';
                    alertDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Por favor, preencha todos os campos obrigatórios marcados com *</span>';
                    
                    const pageHeader = document.querySelector('.page-header');
                    if (pageHeader) {
                        pageHeader.insertAdjacentElement('afterend', alertDiv);
                        setTimeout(() => alertDiv.remove(), 5000);
                    }
                }
            }
        });
    }

    // Remover classe de erro ao digitar
    document.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', function() {
            this.classList.remove('is-invalid');
            if (this !== password2) {
                this.style.borderColor = '';
            }
        });

        input.addEventListener('focus', function() {
            this.classList.remove('is-invalid');
        });
    });
</script>
{% endblock %}