{% extends "base/base.html" %}

{% block title %}Cadastrar Vendedor{% endblock %}
{% block page_title %}Cadastrar Novo Vendedor{% endblock %}
{% block page_subtitle %}Preencha as informações abaixo para registrar um novo vendedor no sistema{% endblock %}

{% block extra_css %}
<style>
    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 24px;
        font-size: 14px;
        color: var(--gray-500);
    }

    .breadcrumb a {
        color: var(--primary);
        text-decoration: none;
        transition: color 0.2s;
    }

    .breadcrumb a:hover {
        color: var(--primary-dark);
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-instructions {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
        border-left: 4px solid var(--primary);
        padding: 20px 24px;
        border-radius: 12px;
        margin-bottom: 28px;
        display: flex;
        gap: 16px;
    }

    .form-instructions-icon {
        width: 48px;
        height: 48px;
        background: var(--primary);
        color: white;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
    }

    .form-instructions-content h4 {
        font-size: 15px;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 10px;
    }

    .form-instructions-content ul {
        font-size: 13px;
        color: var(--gray-600);
        margin: 0;
        padding-left: 20px;
        line-height: 1.9;
    }

    .form-section-title {
        font-size: 17px;
        font-weight: 700;
        color: var(--gray-800);
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--gray-100);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-section-title i {
        color: var(--primary);
    }

    .form-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
        padding-top: 28px;
        border-top: 2px solid var(--gray-100);
        margin-top: 40px;
    }

    .password-strength {
        margin-top: 8px;
        font-size: 12px;
    }

    .strength-bar {
        height: 5px;
        background: var(--gray-200);
        border-radius: 3px;
        overflow: hidden;
        margin-top: 6px;
    }

    .strength-fill {
        height: 100%;
        transition: all 0.3s ease;
        border-radius: 3px;
    }

    .strength-weak .strength-fill {
        width: 33%;
        background: var(--danger);
    }

    .strength-medium .strength-fill {
        width: 66%;
        background: var(--warning);
    }

    .strength-strong .strength-fill {
        width: 100%;
        background: var(--success);
    }

    .input-with-icon {
        position: relative;
    }

    .input-icon {
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-400);
        font-size: 14px;
        pointer-events: none;
        transition: color 0.3s ease;
    }

    .form-control:focus ~ .input-icon,
    .form-control-lg:focus ~ .input-icon {
        color: var(--primary);
    }

    .has-icon {
        padding-right: 44px !important;
    }

    .required-field::after {
        content: '*';
        color: var(--danger);
        margin-left: 4px;
        font-weight: 700;
    }

    .form-help {
        font-size: 12px;
        color: var(--gray-500);
        margin-top: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .form-help i {
        font-size: 11px;
    }

    .requirements-box {
        background: var(--gray-50);
        padding: 20px;
        border-radius: 12px;
        margin-top: 20px;
        border: 1px solid var(--gray-200);
    }

    .requirements-box h6 {
        font-size: 14px;
        font-weight: 700;
        color: var(--gray-700);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .requirements-box ul {
        font-size: 12px;
        color: var(--gray-600);
        margin: 0;
        padding-left: 24px;
        line-height: 2;
    }

    .requirements-box li {
        margin-bottom: 4px;
    }

    .commission-preview {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
        padding: 16px;
        border-radius: 10px;
        border: 1px solid rgba(16, 185, 129, 0.2);
        margin-top: 12px;
    }

    .commission-preview-title {
        font-size: 12px;
        color: var(--success);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .commission-example {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(16, 185, 129, 0.1);
    }

    .commission-example:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }

    .commission-label {
        font-size: 13px;
        color: var(--gray-600);
    }

    .commission-value {
        font-size: 14px;
        font-weight: 700;
        color: var(--success);
    }

    @media (max-width: 768px) {
        .form-instructions {
            flex-direction: column;
        }

        .form-actions {
            flex-direction: column;
        }

        .form-actions .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="breadcrumb">
    <a href="{% url 'dashboard:dashboard_redirect' %}">
        <i class="fas fa-home"></i> Dashboard
    </a>
    <i class="fas fa-chevron-right" style="font-size: 10px;"></i>
    <a href="{% url 'accounts:sellers_list' %}">Vendedores</a>
    <i class="fas fa-chevron-right" style="font-size: 10px;"></i>
    <span>Cadastrar Novo</span>
</div>

<div class="card" style="max-width: 950px; margin: 0 auto;">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-user-plus" style="color: var(--primary);"></i>
            Cadastro de Vendedor
        </h3>
    </div>

    <div class="card-body">
        <div class="form-instructions">
            <div class="form-instructions-icon">
                <i class="fas fa-info-circle"></i>
            </div>
            <div class="form-instructions-content">
                <h4>Informações Importantes</h4>
                <ul>
                    <li>O vendedor receberá um e-mail com as credenciais de acesso ao sistema</li>
                    <li>A taxa de comissão pode ser personalizada para cada vendedor</li>
                    <li>O vendedor poderá lançar suas vendas diariamente através do app mobile</li>
                    <li>Todos os dados podem ser editados posteriormente</li>
                </ul>
            </div>
        </div>

        <form method="post" novalidate id="vendedorForm">
            {% csrf_token %}

            <!-- Dados Pessoais -->
            <h5 class="form-section-title">
                <i class="fas fa-user"></i>
                Dados Pessoais
            </h5>

            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.first_name.id_for_label }}" class="form-label required-field">Nome</label>
                    <div class="input-with-icon">
                        {{ form.first_name }}
                        <i class="fas fa-user input-icon"></i>
                    </div>
                    {% if form.first_name.errors %}
                        {% for error in form.first_name.errors %}
                            <span class="form-error"><i class="fas fa-exclamation-circle"></i> {{ error }}</span>
                        {% endfor %}
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.last_name.id_for_label }}" class="form-label required-field">Sobrenome</label>
                    <div class="input-with-icon">
                        {{ form.last_name }}
                        <i class="fas fa-user input-icon"></i>
                    </div>
                    {% if form.last_name.errors %}
                        {% for error in form.last_name.errors %}
                            <span class="form-error"><i class="fas fa-exclamation-circle"></i> {{ error }}</span>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.email.id_for_label }}" class="form-label required-field">E-mail</label>
                    <div class="input-with-icon">
                        {{ form.email }}
                        <i class="fas fa-envelope input-icon"></i>
                    </div>
                    {% if form.email.errors %}
                        {% for error in form.email.errors %}
                            <span class="form-error"><i class="fas fa-exclamation-circle"></i> {{ error }}</span>
                        {% endfor %}
                    {% endif %}
                    <small class="form-help">
                        <i class="fas fa-info-circle"></i>
                        Este será o login do vendedor no sistema
                    </small>
                </div>

                <div class="form-group">
                    <label for="{{ form.cpf.id_for_label }}" class="form-label required-field">CPF</label>
                    <div class="input-with-icon">
                        {{ form.cpf }}
                        <i class="fas fa-id-card input-icon"></i>
                    </div>
                    {% if form.cpf.errors %}
                        {% for error in form.cpf.errors %}
                            <span class="form-error"><i class="fas fa-exclamation-circle"></i> {{ error }}</span>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>

            <!-- Configuração de Comissão -->
            <h5 class="form-section-title" style="margin-top: 36px;">
                <i class="fas fa-percentage"></i>
                Configuração de Comissão
            </h5>

            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.commission_rate.id_for_label }}" class="form-label required-field">Taxa de Comissão (%)</label>
                    <div class="input-with-icon">
                        {{ form.commission_rate }}
                        <i class="fas fa-percentage input-icon"></i>
                    </div>
                    {% if form.commission_rate.errors %}
                        {% for error in form.commission_rate.errors %}
                            <span class="form-error"><i class="fas fa-exclamation-circle"></i> {{ error }}</span>
                        {% endfor %}
                    {% endif %}
                    <small class="form-help">
                        <i class="fas fa-calculator"></i>
                        Porcentagem de comissão sobre o valor total das vendas
                    </small>
                    
                    <div class="commission-preview" id="commissionPreview" style="display: none;">
                        <div class="commission-preview-title">
                            <i class="fas fa-chart-line"></i> Simulação de Comissão
                        </div>
                        <div class="commission-example">
                            <span class="commission-label">Venda de R$ 1.000,00</span>
                            <span class="commission-value" id="comm1000">R$ 10,00</span>
                        </div>
                        <div class="commission-example">
                            <span class="commission-label">Venda de R$ 5.000,00</span>
                            <span class="commission-value" id="comm5000">R$ 50,00</span>
                        </div>
                        <div class="commission-example">
                            <span class="commission-label">Venda de R$ 10.000,00</span>
                            <span class="commission-value" id="comm10000">R$ 100,00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Senha de Acesso -->
            <h5 class="form-section-title" style="margin-top: 36px;">
                <i class="fas fa-lock"></i>
                Senha de Acesso
            </h5>

            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.password1.id_for_label }}" class="form-label required-field">Senha</label>
                    <div class="input-with-icon">
                        {{ form.password1 }}
                        <i class="fas fa-lock input-icon"></i>
                    </div>
                    {% if form.password1.errors %}
                        {% for error in form.password1.errors %}
                            <span class="form-error"><i class="fas fa-exclamation-circle"></i> {{ error }}</span>
                        {% endfor %}
                    {% endif %}
                    <div class="password-strength" id="passwordStrength" style="display: none;">
                        <div class="strength-bar">
                            <div class="strength-fill"></div>
                        </div>
                        <span class="strength-text" style="font-size: 12px; color: var(--gray-600); margin-top: 4px; display: block;"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="{{ form.password2.id_for_label }}" class="form-label required-field">Confirmar Senha</label>
                    <div class="input-with-icon">
                        {{ form.password2 }}
                        <i class="fas fa-check-circle input-icon" id="passwordMatchIcon" style="display: none; color: var(--success);"></i>
                    </div>
                    {% if form.password2.errors %}
                        {% for error in form.password2.errors %}
                            <span class="form-error"><i class="fas fa-exclamation-circle"></i> {{ error }}</span>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>

            <div class="requirements-box">
                <h6>
                    <i class="fas fa-shield-alt" style="color: var(--info);"></i>
                    Requisitos de Senha
                </h6>
                <ul>
                    <li><i class="fas fa-check" style="color: var(--success); font-size: 10px;"></i> Mínimo de 8 caracteres</li>
                    <li><i class="fas fa-check" style="color: var(--success); font-size: 10px;"></i> Pelo menos uma letra maiúscula e uma minúscula</li>
                    <li><i class="fas fa-check" style="color: var(--success); font-size: 10px;"></i> Pelo menos um número</li>
                    <li><i class="fas fa-check" style="color: var(--success); font-size: 10px;"></i> Recomendado: caractere especial (@, #, $, etc.)</li>
                </ul>
            </div>

            <!-- Botões de Ação -->
            <div class="form-actions">
                <a href="{% url 'accounts:sellers_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Voltar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Cadastrar Vendedor
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Validação de senha em tempo real
    const password1 = document.querySelector('input[name="password1"]');
    const password2 = document.querySelector('input[name="password2"]');
    const strengthDiv = document.getElementById('passwordStrength');
    const matchIcon = document.getElementById('passwordMatchIcon');

    if (password1) {
        password1.addEventListener('input', function() {
            const value = this.value;
            const strength = checkPasswordStrength(value);
            
            if (value.length > 0) {
                strengthDiv.style.display = 'block';
                strengthDiv.className = 'password-strength ' + strength.class;
                strengthDiv.querySelector('.strength-text').textContent = strength.text;
            } else {
                strengthDiv.style.display = 'none';
            }
        });
    }

    if (password2) {
        password2.addEventListener('input', function() {
            const password1Value = password1 ? password1.value : '';
            if (this.value.length > 0 && this.value === password1Value) {
                matchIcon.style.display = 'block';
                matchIcon.className = 'fas fa-check-circle input-icon';
                matchIcon.style.color = 'var(--success)';
                this.style.borderColor = 'var(--success)';
            } else if (this.value.length > 0) {
                matchIcon.style.display = 'block';
                matchIcon.className = 'fas fa-times-circle input-icon';
                matchIcon.style.color = 'var(--danger)';
                this.style.borderColor = 'var(--danger)';
            } else {
                matchIcon.style.display = 'none';
                this.style.borderColor = '';
            }
        });
    }

    function checkPasswordStrength(password) {
        let strength = 0;
        
        if (password.length >= 8) strength++;
        if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
        if (password.match(/[0-9]/)) strength++;
        if (password.match(/[^a-zA-Z0-9]/)) strength++;
        
        if (strength <= 1) {
            return { class: 'strength-weak', text: 'Senha fraca' };
        } else if (strength <= 2) {
            return { class: 'strength-medium', text: 'Senha média' };
        } else {
            return { class: 'strength-strong', text: 'Senha forte' };
        }
    }

    // Preview de comissão em tempo real
    const commissionInput = document.querySelector('input[name="commission_rate"]');
    const commissionPreview = document.getElementById('commissionPreview');
    
    if (commissionInput) {
        commissionInput.addEventListener('input', function() {
            const rate = parseFloat(this.value) || 0;
            
            if (rate > 0) {
                commissionPreview.style.display = 'block';
                document.getElementById('comm1000').textContent = `R$ ${(1000 * rate / 100).toFixed(2)}`;
                document.getElementById('comm5000').textContent = `R$ ${(5000 * rate / 100).toFixed(2)}`;
                document.getElementById('comm10000').textContent = `R$ ${(10000 * rate / 100).toFixed(2)}`;
            } else {
                commissionPreview.style.display = 'none';
            }
        });
    }

    // Máscara de CPF
    const cpfInput = document.querySelector('input[name="cpf"]');
    if (cpfInput) {
        cpfInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                e.target.value = value;
            }
        });
    }

    // Validação do formulário
    const form = document.getElementById('vendedorForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            let isValid = true;
            const requiredInputs = form.querySelectorAll('input[required], input[type="text"], input[type="email"], input[type="password"], input[type="number"]');
            
            requiredInputs.forEach(input => {
                if (!input.value.trim()) {
                    isValid = false;
                    input.classList.add('is-invalid');
                    input.style.borderColor = 'var(--danger)';
                } else {
                    input.classList.remove('is-invalid');
                }
            });

            if (!isValid) {
                e.preventDefault();
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                const existingAlert = document.querySelector('.alert-error');
                if (!existingAlert) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-error';
                    alertDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Por favor, preencha todos os campos obrigatórios marcados com *</span>';
                    
                    const pageHeader = document.querySelector('.page-header');
                    if (pageHeader) {
                        pageHeader.insertAdjacentElement('afterend', alertDiv);
                        setTimeout(() => alertDiv.remove(), 5000);
                    }
                }
            }
        });
    }

    // Remover classe de erro ao digitar
    document.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', function() {
            this.classList.remove('is-invalid');
            if (this !== password2) {
                this.style.borderColor = '';
            }
        });

        input.addEventListener('focus', function() {
            this.classList.remove('is-invalid');
        });
    });
</script>
{% endblock %}